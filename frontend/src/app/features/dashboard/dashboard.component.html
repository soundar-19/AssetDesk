<div class="dashboard">
  <header class="dashboard-header">
    <h1>{{ getDashboardTitle() }}</h1>
    <p>{{ getDashboardDescription() }}</p>
  </header>

  <div *ngIf="loading" class="loading">
    <app-loading-spinner></app-loading-spinner>
  </div>

  <div *ngIf="!loading" class="dashboard-content">
    <!-- Employee Dashboard -->
    <div *ngIf="roleService.isEmployee()" class="employee-view">
      <section class="metrics">
        <div class="metric-card primary">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.myAssets || 0 }}</span>
            <span class="metric-label">My Assets</span>
          </div>
        </div>
        <div class="metric-card warning">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.myIssues || 0 }}</span>
            <span class="metric-label">My Issues</span>
          </div>
        </div>
        <div class="metric-card info" (click)="navigateToRequests()">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.myRequests || 0 }}</span>
            <span class="metric-label">Requests</span>
          </div>
        </div>
      </section>

      <section class="widgets">
        <div class="widget">
          <h3>Recent Activities</h3>
          <div class="activity-list">
            <div *ngFor="let activity of dashboardStats.recentActivities?.slice(0, 4)" class="activity-item">
              <span class="activity-icon">{{ getActivityIcon(activity.type) }}</span>
              <div class="activity-content">
                <p>{{ activity.description }}</p>
                <small>{{ formatTime(activity.timestamp) }}</small>
              </div>
            </div>
            <div *ngIf="!dashboardStats.recentActivities?.length" class="empty">No recent activities</div>
          </div>
        </div>

        <div class="widget">
          <h3>Quick Actions</h3>
          <div class="actions">
            <a routerLink="/requests/new" class="action-btn primary">Request Asset</a>
            <button (click)="showAssetSelectionForIssue()" class="action-btn warning">Report Issue</button>
            <a routerLink="/profile" class="action-btn info">Profile</a>
          </div>
        </div>
      </section>
    </div>

    <!-- IT Support Dashboard -->
    <div *ngIf="roleService.isITSupport() && !roleService.isAdmin()" class="support-view">
      <section class="metrics">
        <div class="metric-card primary">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.totalAssets || 0 }}</span>
            <span class="metric-label">Total Assets</span>
            <span class="metric-trend">{{ getAssetTrend() }}</span>
          </div>
        </div>
        <div class="metric-card success">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.availableAssets || 0 }}</span>
            <span class="metric-label">Available</span>
            <span class="metric-trend">{{ getUtilizationRate() }}% utilized</span>
          </div>
        </div>
        <div class="metric-card warning">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.openIssues || 0 }}</span>
            <span class="metric-label">Open Issues</span>
            <span class="metric-trend">{{ dashboardStats.averageResolutionTime || 0 }}h avg</span>
          </div>
        </div>
        <div class="metric-card info" (click)="navigateToRequests()">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.pendingRequests || 0 }}</span>
            <span class="metric-label">Requests</span>
            <span class="metric-trend">{{ getRequestTrend() }}</span>
          </div>
        </div>
      </section>

      <section class="widgets">
        <div class="widget">
          <h3>Asset Distribution</h3>
          <div class="chart">
            <div *ngFor="let item of getAssetsByStatusArray()" class="chart-item">
              <span class="chart-label">{{ formatStatus(item.key) }}</span>
              <div class="chart-bar">
                <div class="bar-fill" [style.width.%]="getPercentage(item.value, getTotalAssets())"></div>
              </div>
              <span class="chart-value">{{ item.value }}</span>
            </div>
          </div>
        </div>

        <div class="widget">
          <h3>Priority Issues</h3>
          <div class="issue-list">
            <div *ngFor="let issue of dashboardStats.topIssues?.slice(0, 4)" class="issue-item">
              <div class="issue-priority priority-{{ issue.priority.toLowerCase() }}"></div>
              <div class="issue-content">
                <h4>{{ issue.title }}</h4>
                <small>{{ issue.reportedBy }} • {{ formatDate(issue.createdAt) }}</small>
              </div>
              <a [routerLink]="['/issues', issue.issueId]" class="issue-link">View</a>
            </div>
            <div *ngIf="!dashboardStats.topIssues?.length" class="empty">No priority issues</div>
          </div>
        </div>

        <div class="widget">
          <h3>Quick Actions</h3>
          <div class="actions">
            <a routerLink="/assets/new" class="action-btn primary">Add Asset</a>
            <a routerLink="/requests" class="action-btn warning">Requests</a>
            <a routerLink="/service-records" class="action-btn info">Service</a>
            <a routerLink="/vendors" class="action-btn secondary">Vendors</a>
          </div>
        </div>
      </section>
    </div>

    <!-- Admin Dashboard -->
    <div *ngIf="roleService.isAdmin()" class="admin-view">
      <section class="metrics">
        <div class="metric-card primary">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.totalAssets || 0 }}</span>
            <span class="metric-label">Assets</span>
            <span class="metric-trend">{{ getAssetTrend() }}</span>
          </div>
        </div>
        <div class="metric-card success">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.totalUsers || 0 }}</span>
            <span class="metric-label">Users</span>
            <span class="metric-trend">{{ getActiveUsers() }} active</span>
          </div>
        </div>
        <div class="metric-card warning">
          <div class="metric-info">
            <span class="metric-value">{{ dashboardStats.openIssues || 0 }}</span>
            <span class="metric-label">Issues</span>
            <span class="metric-trend">{{ getIssueTrend() }}</span>
          </div>
        </div>
        <div class="metric-card info" (click)="navigateToRequests()">
          <div class="metric-info">
            <span class="metric-value">{{ getTotalRequests() }}</span>
            <span class="metric-label">Requests</span>
            <span class="metric-trend">{{ getRequestTrend() }}</span>
          </div>
        </div>
        <div class="metric-card secondary">
          <div class="metric-info">
            <span class="metric-value">{{ getUtilizationRate() }}%</span>
            <span class="metric-label">Utilization</span>
            <span class="metric-trend">{{ dashboardStats.availableAssets || 0 }} available</span>
          </div>
        </div>
      </section>

      <section class="widgets admin-layout">
        <div class="widget-column">
          <div class="widget small">
            <h3>System Overview</h3>
            <div class="overview-stats">
              <div class="stat-item">
                <span class="stat-number">{{ dashboardStats.totalAssets || 0 }}</span>
                <span class="stat-label">Total Assets</span>
              </div>
              <div class="stat-item">
                <span class="stat-number">{{ dashboardStats.availableAssets || 0 }}</span>
                <span class="stat-label">Available</span>
              </div>
              <div class="stat-item">
                <span class="stat-number">{{ dashboardStats.allocatedAssets || 0 }}</span>
                <span class="stat-label">Allocated</span>
              </div>
            </div>
          </div>

          <div class="widget small">
            <h3>Asset Categories</h3>
            <div class="chart">
              <div *ngFor="let category of getAssetCategoriesArray()" class="chart-item">
                <span class="chart-label">{{ category.key }}</span>
                <div class="chart-bar">
                  <div class="bar-fill" [style.width.%]="getPercentage(category.value, getTotalAssets())"></div>
                </div>
                <span class="chart-value">{{ category.value }}</span>
              </div>
            </div>
          </div>

          <div class="widget small">
            <h3>Admin Actions</h3>
            <div class="actions">
              <a routerLink="/users/new" class="action-btn primary">Add User</a>
              <a routerLink="/assets/new" class="action-btn success">Add Asset</a>
              <a routerLink="/reports" class="action-btn info">Reports</a>
              <a routerLink="/vendors" class="action-btn secondary">Vendors</a>
            </div>
          </div>
        </div>

        <div class="widget activity-column">
          <h3>Recent Activities</h3>
          <div class="activity-list">
            <div *ngFor="let activity of dashboardStats.recentActivities?.slice(0, 8)" class="activity-item">
              <span class="activity-icon">{{ getActivityIcon(activity.type) }}</span>
              <div class="activity-content">
                <p>{{ activity.description }}</p>
                <div class="activity-meta">
                  <small>{{ activity.user }} • {{ formatTime(activity.timestamp) }}</small>
                </div>
              </div>
              <span class="activity-status status-{{ activity.status.toLowerCase() }}">
                {{ formatStatus(activity.status) }}
              </span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Asset Selection Modal -->
  <div class="modal" *ngIf="showAssetSelection" (click)="closeAssetSelection()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Select Asset to Report Issue</h3>
        <button class="close-btn" (click)="closeAssetSelection()">×</button>
      </div>
      <div class="modal-body">
        <div class="asset-list" *ngIf="userAssets.length > 0; else noAssets">
          <div *ngFor="let asset of userAssets" class="asset-item" (click)="selectAssetForIssue(asset)">
            <div class="asset-info">
              <div class="asset-name">{{ asset.name }}</div>
              <div class="asset-tag">{{ asset.assetTag }}</div>
            </div>
          </div>
        </div>
        <ng-template #noAssets>
          <div class="empty">You have no assets assigned to report issues for.</div>
        </ng-template>
      </div>
    </div>
  </div>
</div>